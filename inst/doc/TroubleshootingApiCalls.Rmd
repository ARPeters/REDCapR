<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Troubleshooting REDCap API Calls}
-->

# Troubleshooting REDCap API Calls
There are many links in the pipeline between your institution's [REDCap](http://www.project-redcap.org/) server and the API user.  When the end result is unsuccesful, this document should help narrow the location of the possible problem.  The first two sections will be relevant to almost any language interacting with the API.  The remaining sections are possibly relevant only to your language (eg, Python, R, SAS, bash), or your software library ([redcap](https://github.com/jeffreyhorner/redcap) and [REDCapR](https://github.com/OuhscBbmc/REDCapR) in R and [PyCap](http://sburns.org/PyCap/) in Python).

## Server Configuration and Authorization
This first group of checks primarily focuses on the server and the logins accounts.  Unlike the other sections, REDCap administrator privileges are necessary for most of these checks.

 1. **Does the user have an account for the *server*?**  
 This can be verified in the `Browse Users` section of the server's `Control Center`.
 
 1. **Does the user have permissions for the specific *project*?**  
 This can be verified in the `User Rights` section within the project.  Notice that it's possible (but ultimately not useful) to have an account here, but not with the server, so don't skip the previous step.
 
 1. **Can the user login in normally through the interface?**  
 However if the username and password aren't working, the API theoretically might still work because it uses their token instead of their password.
 
 1. **Has the user verified their account by responding to the automated email sent to them?**  
 This can be verified in the `Browse Users` section of your server's `Control Center`.  For each email address they've entered, there should be a green 'Verified' label and icon.
 
 1. **Has the user been granted the desired import and/or export permissions?**  
 This can be verified in the `User Rights` section or in the `API` section (and it's `Manage All Project Tokens` tab) within the project.  Alternatively, it can be verified in the `API Tokens` section of the server's `Control Center`.
 
 1. **Are they using the correct token?**  
 This can be verified in the `API` section (and it's `Manage All Project Tokens` tab) within the project.  Click the magnifying glass icon in the user's row.  Alternatively, it can be verified in the `API Tokens` section of the server's `Control Center`.

## Language Agnostic API
This section group examines potential problems that occur after it leaves a working server, but before it is handled by their programming language (eg, Python and R).  [Postman](http://www.getpostman.com/) is a Chrome plugin recommended by several people, including [Andy Martin](https://groups.google.com/forum/#!searchin/project-redcap/postman/project-redcap/eYK_SLzW2k4/0hmf8vWLpdAJ).  It makes trouble shooting much more efficient.

 <img src="./images/PostmanScreenshot.png" alt="PostmanScreenshot" style="width: 800px;"/>

 1. **Is Postman installed and operating correctly?**  
 If it helps to start with a different REDCap server, you can use this dummy project containing fake data hosted by the [OUHSC BBMC](http://ouhsc.edu/bbmc/).  The url can be found in the screenshot above.  There are three key-value pairs: (1) the 'token' is `9A81268476645C4E5F03428B8AC3AA7B`, (2) the 'content' is `record`, and (3) the 'format' should be `CSV`.  When checking your own server, the token value should change, but the content and format should not.  It should return five records in a CSV format.  The 'status' should be `200 OK`.  The result should look roughly like:
 
 ```
 record_id,first_name,last_name,address,telephone,email,dob,age,ethnicity,race,sex,height,weight,bmi,comments,demographics_complete
  "1","Nutmeg","Nutmouse","14 Rose Cottage St.
  Kenning UK, 323232","(432) 456-4848","nutty@mouse.com","2003-08-30",10,1,2,0,5,1,400,"Character in a book, with some guessing",2
  "2","Tumtum","Nutmouse","14 Rose Cottage Blvd.
  Kenning UK 34243","(234) 234-2343","tummy@mouse.comm","2003-03-10",10,1,6,1,6,1,277.8,"A mouse character from a good book",2
  "3","Marcus","Wood","243 Hill St.
  Guthrie OK 73402","(433) 435-9865","mw@mwood.net","1934-04-09",79,0,4,1,180,80,24.7,"completely made up",2
  "4","Trudy","DAG","342 Elm
  Duncanville TX, 75116","(987) 654-3210","peroxide@blonde.com","1952-11-02",61,1,4,0,165,54,19.8,"This record doesn't have a DAG assigned
  
  So call up Trudy on the telephone
  Send her a letter in the mail",2
  "5","John Lee","Walker","Hotel Suite
  New Orleans LA, 70115","(333) 333-4444","left@hippocket.com","1955-04-15",58,1,4,1,193.04,104,27.9,"Had a hand for trouble and a eye for cash
  
  He had a gold watch chain and a black mustache",2
 ```
 
 1. **Can an administrator query the API successfully with Postman with the admin token?**  
 As an administrator, create an account for yourself, and verify that your token works on your server and project.
  
 1. **Can an administrator query the API successfully with Postman with the user's token?**  
 Use Postman as before, but replace your token with the user's token.  Once the whole problem is solved, consider reissuing a new API token.
 
 1. **Can an user query the API successfully with Postman with the their own token?**  
 The values they enter should be exactly the same as those entered in the previous step.  A failure here (assuming the previous step was successful) suggests a network or firewall issue.  If the server is behind your instituion's firewall, verify the user is connecting successfully through the VPN.
 
## Calling API from R
There are several ways to call REDCap's API from [R](http://cran.r-project.org/).  The packages [redcap](https://github.com/jeffreyhorner/redcap) and [REDCapR](https://github.com/OuhscBbmc/REDCapR) both rely on the [RCurl](http://cran.r-project.org/web/packages/RCurl) package.
 
 1. **Is RCurl installed on the user's local machine?**  
 If so, running `require(RCurl)` should produce the following output if you're starting with a fresh session of R:
 
 ``` r
  > require(RCurl)
  Loading required package: RCurl
  Loading required package: bitops
 ``` 
 
 1. **Does the user have the most recent version of RCurl?**   
 There are several ways to do this, but the easiest is probably to run `update.packages(ask=FALSE)`.  That optional argument prevents the user from needing to respond 'Y' to updating each outdated package.
 
 1. **Can the user query a *subset* of the REDCap project using RCurl?**   
 Both the [redcap](https://github.com/jeffreyhorner/redcap) and [REDCapR](https://github.com/OuhscBbmc/REDCapR) employ something similar to the following function in [RCurl](http://cran.r-project.org/web/packages/RCurl).  If you're curious, here is the relevant source code for [https://github.com/jeffreyhorner/redcap/blob/master/R/exportRecords.R](redcap) and [REDCapR](https://github.com/OuhscBbmc/REDCapR/blob/master/R/redcap_read_oneshot.R).
 
 If this fails, consider attempting again with the uri and token used above in the Postman example.
 
 This check avoids SSL in order to simplify the troubleshooting.  SSL is supported by default in the [PyCap](http://sburns.org/PyCap/) and [REDCapR](https://github.com/OuhscBbmc/REDCapR) packages.
    
  ```
    redcap_uri <- "https://the.urlofyourinsitution.edu/api/" #Adapt this to your server.
    token <- "your-secret-token" #Adapt this to your user's token.
    records_collapsed <- "1,2,3" #This assumes that their dataset contains ID values of 1, 2, and 3.  Adapt this to their dataset.
    fields_collapsed <- "record_id,first_name,last_name" #This assumes that their dataset contains variables called 'recordid', 'first_name', and 'last_name'.  Adapt this to their dataset.
    
    raw_csv <- RCurl::postForm(
      uri = redcap_uri
      , token = token
      , content = 'record'
      , format = 'csv'
      , type = 'flat'
      , rawOrLabel = 'raw'
      , exportDataAccessGroups = 'true'
      , records = records_collapsed
      , fields = fields_collapsed
      , .opts = RCurl::curlOptions(ssl.verifypeer = FALSE)
    )
  ``` 
 1. **Can the user query a *entire* REDCap project using RCurl?**   
 There are two advantages of trying a subset of the data.  First, small datasets avoid the time-out errors that plague large datasets.  Second, it may avoid problematic values being passed through the pipeline.  If the current check fails but the previous check succeedes, then experiment with different expanses of records and fields.  This should help determine which values are causing the problems, or if there's simply too much data being pulled in one pass.  
 
 If the desired dataset is too large, consider if you can prune unnecessary records or fields.  If not, one solution is to pull smaller, multiple batches using the API, then reassemble them.  The `redcap_read()` function in [REDCapR](https://github.com/OuhscBbmc/REDCapR/blob/master/DocumentationPeek.pdf) does this automatically, and allows the user to specify a `batch_size`.
 
  ```
    redcap_uri <- "https://the.urlofyourinsitution.edu/api/" #Adapt this to your server.
    token <- "your-secret-token" #Adapt this to your user's token.
    records_collapsed <- NULL
    fields_collapsed <- NULL
    
    raw_csv <- RCurl::postForm(
      uri = redcap_uri
      , token = token
      , content = 'record'
      , format = 'csv'
      , type = 'flat'
      , rawOrLabel = 'raw'
      , exportDataAccessGroups = 'true'
      , records = records_collapsed
      , fields = fields_collapsed
      , .opts = RCurl::curlOptions(ssl.verifypeer = FALSE)
    )
  ```

## Document Info
This document is primarily based on REDCap version 5.11.3, and was last updated 2016-06-27.
